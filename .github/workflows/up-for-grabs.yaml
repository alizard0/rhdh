# .github/workflows/up-for-grabs.yml
name: 'UpForGrabsAgent (Gemini Edition)'

on:
  pull_request:
    types: [opened, ready_for_review]
permissions:
  pull-requests: write # To add labels and comments
  contents: read      # To checkout the code and run git diff

jobs:
  up-for-grabs-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to get the base commit for git diff

      - name: Let the UpForGrabsAgent analyze the PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Agent Configuration
            const AGENT_NAME = "UpForGrabsAgent";
            const TARGET_LABEL = "good-first-issue";
            const PRE_SCREEN_THRESHOLD = 65;
            // --- GEMINI CONFIGURATION ---
            const LLM_MODEL = "gemini-1.5-flash-latest"; // Fast and cost-effective Gemini model
            const GEMINI_API_KEY = "${{ secrets.GEMINI_API_KEY }}";

            // Context from the GitHub event
            const pr = context.payload.pull_request;
            const repo = context.repo;

            // --- 1. Guard Clause: Skip Draft/WIP PRs ---
            const title = pr.title.toLowerCase();
            if (pr.draft || title.startsWith('wip') || title.startsWith('[wip]') || title.startsWith('draft')) {
              console.log(`${AGENT_NAME}: PR is a draft or WIP. Skipping analysis.`);
              return;
            }

            // =================================================================
            // === STAGE 1: HEURISTIC PRE-SCREENING (No changes here) ==========
            // =================================================================
            let heuristicScore = 0;
            const reasons = [];
            const totalChanges = pr.additions + pr.deletions;
            if (totalChanges <= 10) { heuristicScore += 40; reasons.push('ðŸŽ¯ Micro-change'); }
            else if (totalChanges <= 40) { heuristicScore += 20; reasons.push('âœ… Small code change'); }
            if (pr.changed_files <= 2) { heuristicScore += 20; reasons.push('âœ… Focused scope (few files)'); }
            const author = pr.user.login;
            if (author.includes('dependabot[bot]') || author.includes('renovate[bot]')) { heuristicScore += 25; reasons.push('ðŸ“¦ Dependency update'); }
            const body = (pr.body || '').toLowerCase();
            if (title.includes('cherry-pick') || body.includes('cherry-pick')) { heuristicScore += 15; reasons.push('ðŸ’ Cherry-pick detected'); }
            
            console.log(`${AGENT_NAME}: Heuristic pre-screen score: ${heuristicScore} (Threshold: ${PRE_SCREEN_THRESHOLD}). Reasons: ${reasons.join(', ')}`);

            if (heuristicScore < PRE_SCREEN_THRESHOLD) {
              console.log(`${AGENT_NAME}: PR did not pass the heuristic pre-screening. Halting.`);
              return;
            }

            // =================================================================
            // === STAGE 2: LLM VALIDATION (Updated for Gemini) ================
            // =================================================================
            console.log(`${AGENT_NAME}: PR passed pre-screening. Proceeding to Gemini validation.`);
            try {
              const { execSync } = require('child_process');
              const diff = execSync(`git diff ${pr.base.sha}..${pr.head.sha}`).toString();

              if (diff.length > 8000 || diff.length === 0) {
                console.log(`${AGENT_NAME}: Diff is too large or empty. Skipping LLM analysis.`);
                return;
              }

              const prompt = `
                You are an expert code reviewer and onboarding assistant named "${AGENT_NAME}". Your goal is to analyze a code diff that has been pre-selected as a likely candidate for a new team member.

                **TASK:**
                Validate if this change is genuinely simple and provide a helpful, plain-English guide for a beginner. Analyze the code diff and provide your response in the specified JSON format. The JSON should be the only thing in your response.

                **ASSESSMENT CRITERIA & OUTPUT FORMAT:**
                1.  \`is_confirmed_simple\`: A boolean (\`true\` or \`false\`). Is this change truly simple and low-risk, even after inspecting the code?
                2.  \`summary_for_newcomer\`: A friendly, one- or two-sentence summary explaining the purpose of this change. Assume you're talking to someone with zero knowledge of this codebase.
                3.  \`review_guidance\`: A few bullet points suggesting what the newcomer should look for during their review. For example: "Confirm the new button appears correctly," or "Check that the tests still pass after this dependency is updated."

                **CODE DIFF TO ANALYZE:**
                \`\`\`diff
                ${diff}
                \`\`\`

                **YOUR RESPONSE (JSON only):**
              `;

              // --- GEMINI API CALL ---
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
              const requestBody = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" } // This tells Gemini to output JSON directly!
              };

              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
              });

              if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API call failed: ${response.statusText}. Body: ${errorBody}`);
              }
              
              const result = await response.json();
              // Gemini's JSON mode provides the parsed object directly in the text part.
              const llmAnalysis = JSON.parse(result.candidates[0].content.parts[0].text);

              if (!llmAnalysis.is_confirmed_simple) {
                console.log(`${AGENT_NAME}: Gemini analysis concluded the PR is not simple enough. Halting.`);
                return;
              }

              // --- FINAL ACTION: Label and Comment ---
              console.log(`${AGENT_NAME}: Gemini confirmed PR is simple. Applying label and posting comment.`);
              await github.rest.issues.addLabels({ ...repo, issue_number: pr.number, labels: [TARGET_LABEL] });

              const commentBody = `ðŸ¤– **${AGENT_NAME} has spotted an opportunity!**\n\nThis pull request looks like a great place for new contributors to get started.\n\n### What's happening in this PR?\n${llmAnalysis.summary_for_newcomer}\n\n### How to review this change\n${llmAnalysis.review_guidance}\n\n---\n*This is an automated guide. A maintainer can remove the \`${TARGET_LABEL}\` label if this analysis is incorrect.*`;
              await github.rest.issues.createComment({ ...repo, issue_number: pr.number, body: commentBody });

            } catch (error) {
              console.error(`${AGENT_NAME}: Gemini analysis stage failed:`, error);
            }